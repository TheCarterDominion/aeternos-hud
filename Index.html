<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
<title>Aeternos • Safe Mode v4 (Audio & iPad Touch Fix)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root{--ink:#ecf3ff;--mut:#9fb3cc;--a:#62d3ff;--b:#ff49f0;--bg:#050916;--panel:#0f1a33}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:radial-gradient(1600px 1000px at 50% 8%,#060b1c,#02040c);color:var(--ink);
  font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; -webkit-text-size-adjust:100%;
  overscroll-behavior:none}
body,button{user-select:none;-webkit-user-select:none}
.app{position:fixed;inset:0;display:flex;flex-direction:column}
.top{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px}
h1{margin:0;font-size:18px;text-shadow:0 0 14px rgba(98,211,255,.6)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:2px solid rgba(255,255,255,.7);background:transparent;color:var(--ink);padding:8px 10px;border-radius:12px;font-size:14px}
.btn.small{padding:6px 8px;font-size:12px;border-radius:10px}
.pill{border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:5px 9px;background:rgba(255,255,255,.06);font-size:12px}
.panel{flex:1;display:none}
.panel.active{display:block}
.card{height:100%;display:flex;align-items:center;justify-content:center;padding:12px}
.box{width:100%;max-width:1100px;background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45);padding:12px}
.frame{width:100%;height:420px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:#050912;position:relative;overflow:hidden}
canvas{display:block;width:100%;height:100%;background:#050912;border-radius:12px;touch-action:manipulation}
.badge{position:absolute;top:8px;left:8px;background:rgba(98,211,255,.14);border:1px solid rgba(98,211,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}
.hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px 0}
.mut{color:var(--mut);font-size:12px}

/* Fullscreen gate */
.gate{position:fixed;inset:0;background:linear-gradient(180deg,#07122b,#050912 60%);display:flex;align-items:center;justify-content:center;
  z-index:9999}
.gate_inner{max-width:560px;text-align:center;border:1px solid rgba(255,255,255,.15);background:#0f1a33;border-radius:18px;padding:18px;box-shadow:0 12px 36px rgba(0,0,0,.5)}
.gate h2{margin:0 0 8px 0}
.gate p{margin:6px 0;color:var(--mut)}
.gate .btn{margin-top:8px}

/* grid */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.tile{background:#091024;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px}
.ok{color:#5cffb1}.warn{color:#ffd76a}.err{color:#ff6b6b}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <h1>Aeternos — Safe Mode v4</h1>
    <div class="nav">
      <button class="btn" data-view="hub">Hub</button>
      <button class="btn" data-view="runner">Runner</button>
      <button class="btn" data-view="healing">Healing</button>
      <button class="btn" data-view="diag">Diagnostics</button>
    </div>
    <div>
      <button class="btn small" id="audio_stop">Stop All</button>
      <span class="pill" id="audio_state">Audio: Off</span>
    </div>
  </div>

  <!-- HUB -->
  <section id="v-hub" class="panel active">
    <div class="card"><div class="box">
      <div class="grid">
        <div class="tile">
          <div style="font-weight:700;margin-bottom:6px">Touch Test</div>
          <div class="frame"><div class="badge">Tap / Touch / Mouse</div><canvas id="touch_canvas" height="240"></canvas></div>
          <div class="hud"><span class="pill">Touches <b id="t_count">0</b></span><span class="pill">Last <b id="t_last">—</b></span></div>
          <div class="mut">If this increments and dots appear, input is good.</div>
        </div>
        <div class="tile">
          <div style="font-weight:700;margin-bottom:6px">Quick Start</div>
          <div class="mut">If you ever get a stuck hum, press <b>Stop All</b> (top-right).</div>
          <div class="mut">Audio unlock is handled by the big “Tap to Start” screen at load.</div>
        </div>
      </div>
    </div></div>
  </section>

  <!-- RUNNER -->
  <section id="v-runner" class="panel">
    <div class="card"><div class="box">
      <div class="hud">
        <span class="pill">Score <b id="r_score">0</b></span>
        <span class="pill">Shield <b id="r_shield">100%</b></span>
        <button class="btn small" id="r_pause">Pause</button>
        <button class="btn small" id="r_reset">Restart</button>
        <span class="mut">Tap to jump • swipe down to duck</span>
      </div>
      <div class="frame"><div class="badge">Pulse Runner — v4</div><canvas id="r_canvas" height="420"></canvas></div>
    </div></div>
  </section>

  <!-- HEALING -->
  <section id="v-healing" class="panel">
    <div class="card"><div class="box">
      <div class="hud">
        <button class="btn small h_pad" data-f="396">396</button>
        <button class="btn small h_pad" data-f="432">432</button>
        <button class="btn small h_pad" data-f="528">528</button>
        <button class="btn small h_pad" data-f="639">639</button>
        <button class="btn small" id="h_stop">Stop Pads</button>
        <span class="pill">Status: <b id="h_status">Idle</b></span>
      </div>
      <div class="frame"><div class="badge">Sound Healing — v4</div><canvas id="h_canvas" height="420"></canvas></div>
    </div></div>
  </section>

  <!-- DIAGNOSTICS -->
  <section id="v-diabox" class="panel">
    <div class="card"><div class="box">
      <div style="font-weight:700;margin-bottom:6px">Audio & Input Diagnostics</div>
      <div class="grid">
        <div class="tile">
          <div class="hud">
            <button class="btn small" id="d_ping">Ping Tone</button>
            <button class="btn small" id="d_tri">Triangle 660Hz</button>
            <button class="btn small" id="d_stop">Stop All</button>
          </div>
          <div class="mut" id="d_status">Status: waiting</div>
          <div class="mut">If you press Ping and hear nothing on iPad/Note8, the browser blocked audio. Reload and tap the **Tap to Start** screen once.</div>
        </div>
        <div class="tile">
          <div class="mut">AudioContext: <b id="d_ctx">—</b></div>
          <div class="mut">State: <b id="d_state">—</b></div>
          <div class="mut">Unlocked via: <b id="d_unlock">—</b></div>
        </div>
      </div>
    </div></div>
  </section>
</div>

<!-- Fullscreen “Tap to Start” (unlocks audio + input on iOS/Android) -->
<div id="gate" class="gate" role="button" aria-label="Tap to Start">
  <div class="gate_inner">
    <h2>Tap to Start</h2>
    <p>This unlocks audio (iOS/Android policy) and primes input.</p>
    <button class="btn" id="gate_btn">Start</button>
    <p class="mut">If you see this again, a reload happened. Tap once, then use the app.</p>
  </div>
</div>

<script>
/* ============= Helpers ============= */
function gid(x){return document.getElementById(x)}
function setupCanvas(cvs){
  const ctx=cvs.getContext('2d',{alpha:false}); ctx.imageSmoothingEnabled=false;
  let DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  function resize(){ const w=cvs.clientWidth||600, h=cvs.clientHeight||300; cvs.width=(w*DPR)|0; cvs.height=(h*DPR)|0; ctx.setTransform(DPR,0,0,DPR,0,0); }
  if('ResizeObserver' in window){ try{ new ResizeObserver(resize).observe(cvs); }catch{ addEventListener('resize',resize); } } else addEventListener('resize',resize);
  resize(); return {ctx,DPR};
}
function onCanvasTap(c,fn){
  const rel=e=>{ const r=c.getBoundingClientRect(); return {x:(e.clientX??0)-r.left,y:(e.clientY??0)-r.top}; };
  c.addEventListener('pointerdown',e=>{ fn(rel(e),e); e.preventDefault(); },{passive:false});
  c.addEventListener('touchstart',e=>{ const t=e.changedTouches?.[0]; if(!t) return; const r=c.getBoundingClientRect(); fn({x:t.clientX-r.left,y:t.clientY-r.top},e); e.preventDefault(); },{passive:false});
  c.addEventListener('mousedown',e=>fn(rel(e),e));
}

/* ============= Global Audio Engine with Multi-Unlock ============= */
const AudioEngine=(()=>{
  let AC=null, master=null, unlockedBy='—';
  const live=new Set();
  function make(){ if(AC) return; AC=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'}); master=AC.createGain(); master.gain.value=.7; master.connect(AC.destination);}
  function state(){ return AC?AC.state:'none'; }
  function updateBadge(){ gid('audio_state').textContent = AC && AC.state==='running' ? 'Audio: On' : (AC ? ('Audio: '+AC.state) : 'Audio: Off'); gid('d_ctx').textContent = AC? 'AudioContext' : '—'; gid('d_state').textContent = state(); gid('d_unlock').textContent=unlockedBy; }
  function tinyClick(){ // inaudible blip to finalize unlock
    if(!AC) return; const o=AC.createOscillator(), g=AC.createGain(); o.frequency.value=40; g.gain.value=0.0001; o.connect(g); g.connect(master);
    const t=AC.currentTime; o.start(t); o.stop(t+0.04); live.add(o); o.onended=()=>live.delete(o);
  }
  async function resume(tag){
    make();
    if(!AC) return false;
    try{ if(AC.state!=='running'){ await AC.resume(); unlockedBy=tag||unlockedBy; tinyClick(); } }catch{}
    updateBadge(); return AC.state==='running';
  }
  function tone(f=440,d=.15,v=.22,type='sine'){ if(!AC) return; const t=AC.currentTime, o=AC.createOscillator(), g=AC.createGain();
    o.type=type; o.frequency.value=f; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(v,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(master); o.start(t); o.stop(t+d+.02); live.add(o); o.onended=()=>live.delete(o); }
  function stopAll(){ live.forEach(n=>{try{n.stop(0)}catch{}}); live.clear(); updateBadge(); }
  // Multi unlock hooks
  ['pointerdown','touchstart','mousedown','keydown'].forEach(evt=>{
    addEventListener(evt,()=>resume(evt),{once:false,passive:true});
  });
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') resume('visible'); });
  return {resume,tone,stopAll,get AC(){return AC}, get master(){return master}, updateBadge};
})();
AudioEngine.updateBadge();
gid('audio_stop').onclick=()=>AudioEngine.stopAll();

/* ============= Router ============= */
const V={hub:gid('v-hub'),runner:gid('v-runner'),healing:gid('v-healing'),diag:gid('v-diabox')};
document.querySelectorAll('[data-view]').forEach(b=>b.addEventListener('click',()=>{ Object.values(V).forEach(v=>v.classList.remove('active')); V[b.dataset.view].classList.add('active'); if(b.dataset.view==='runner') bootRunner(); if(b.dataset.view==='healing') bootHealing(); }));

/* ============= Gate (first tap to unlock audio/input for iPad/Android) ============= */
const gate=gid('gate'), gateBtn=gid('gate_btn');
async function openGate(){ await AudioEngine.resume('gate'); AudioEngine.tone(660,.08,.18,'triangle'); setTimeout(()=>AudioEngine.tone(880,.08,.16,'sine'),90); gate.style.display='none'; }
gate.addEventListener('pointerdown',openGate,{once:true}); gate.addEventListener('touchstart',e=>{e.preventDefault(); openGate();},{once:true,passive:false}); gateBtn.addEventListener('click',openGate,{once:true});

/* ============= HUB touch test ============= */
(()=>{ const cvs=gid('touch_canvas'); const {ctx}=setupCanvas(cvs); const countEl=gid('t_count'), lastEl=gid('t_last'); let count=0;
  ctx.fillStyle='#050912'; ctx.fillRect(0,0,cvs.clientWidth,cvs.clientHeight);
  onCanvasTap(cvs,(p,ev)=>{ count++; countEl.textContent=''+count; lastEl.textContent=ev.pointerType||ev.type; ctx.fillStyle='#62d3ff'; ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill(); });
})();

/* ============= Runner (minimal, stable) ============= */
let runnerBoot=false;
function bootRunner(){ if(runnerBoot) return; runnerBoot=true;
const cvs=gid('r_canvas'); const {ctx}=setupCanvas(cvs);
const W=()=>cvs.clientWidth||600,H=()=>cvs.clientHeight||300;
const ui={score:gid('r_score'),shield:gid('r_shield'),pause:gid('r_pause'),reset:gid('r_reset')};
let paused=false, over=false, score=0, shield=100;
const ply={x:120,y:0,w:44,h:56,vy:0,ground:0,duck:0};
const GRAV=1.0, HOLD=.35, JMAX=-32; let holding=false;
function reset(){ over=false; paused=false; score=0; shield=100; const g=(H()-98)|0; ply.h=56; ply.ground=g; ply.y=g-ply.h; ply.vy=0; ply.duck=0; ui.score.textContent='0'; ui.shield.textContent='100%'; }
reset();
function jump(){ if(over) return; if(ply.y>=ply.ground-ply.h-0.1){ ply.vy=JMAX; holding=true; AudioEngine.tone(620,.1,.2,'triangle'); } }
function duck(){ if(over) return; if(ply.duck>0) return; const feet=ply.y+ply.h; ply.h=32; ply.y=feet-ply.h; ply.duck=18; AudioEngine.tone(480,.06,.16,'square'); }
let startY=null;
onCanvasTap(cvs,(p,e)=>{ jump(); startY=e.clientY||null; });
addEventListener('pointermove',e=>{ if(startY!=null && (e.clientY-startY)>60){ duck(); startY=null; }},{passive:true});
addEventListener('pointerup',()=>{ holding=false; startY=null; },{passive:true});
addEventListener('touchend',()=>{ holding=false; startY=null; },{passive:true});

const obs=[]; let cd=0;
function spawn(){ const g=ply.ground; if(Math.random()<0.6) obs.push({x:W()+40,y:g-28,w:28,h:28}); else obs.push({x:W()+40,y:g-60,w:28,h:60}); }
function step(){
  if(paused||over) return;
  ply.vy += (holding && ply.vy<0) ? HOLD : GRAV; ply.y += ply.vy;
  if(ply.y>ply.ground-ply.h){ ply.y=ply.ground-ply.h; ply.vy=0; holding=false; if(ply.duck>0){ ply.duck--; if(ply.duck===0){ const feet=ply.y+ply.h; ply.h=56; ply.y=feet-ply.h; } } }
  if(--cd<=0){ cd=82; spawn(); }
  for(let i=obs.length-1;i>=0;i--){ const o=obs[i]; o.x-=6.2; if(o.x+o.w<-20){ obs.splice(i,1); score++; ui.score.textContent=''+score; } }
  const b={x:ply.x+3,y:ply.y+(ply.duck?8:4),w:ply.w-6,h:(ply.duck?32:ply.h-8)};
  for(const o of obs){ if(o.x<b.x+b.w && o.x+o.w>b.x && o.y<b.y+b.h && o.y+o.h>b.y){ shield=Math.max(0,shield-34); ui.shield.textContent=shield+'%'; AudioEngine.tone(220,.12,.22,'square'); if(shield<=0) over=true; } }
}
function draw(){
  const w=W(),h=H(); ctx.fillStyle='#050912'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='rgba(255,255,255,.1)'; ctx.fillRect(0,Math.floor(ply.ground+2)+.5,w,2);
  ctx.fillStyle='#ff49f0'; for(const o of obs){ ctx.fillRect(o.x|0,o.y|0,o.w|0,o.h|0); }
  ctx.fillStyle='#62d3ff'; ctx.fillRect(ply.x|0,ply.y|0,(ply.w)|0,(ply.duck?32:ply.h)|0);
  if(over){ ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,w,h); ctx.fillStyle='#ecf3ff'; ctx.font='18px -apple-system,system-ui'; ctx.fillText('Game Over — tap Restart',12,24); }
}
(function loop(){ step(); draw(); requestAnimationFrame(loop); })();
ui.pause.onclick=()=>{ if(over){ reset(); return; } paused=!paused; ui.pause.textContent=paused?'Resume':'Pause'; };
ui.reset.onclick=()=>{ obs.length=0; reset(); };
}

/* ============= Healing (pads + guaranteed Stop) ============= */
let healBoot=false;
function bootHealing(){ if(healBoot) return; healBoot=true;
const cvs=gid('h_canvas'); const {ctx}=setupCanvas(cvs); const pads=[...document.querySelectorAll('.h_pad')], stopB=gid('h_stop'), status=gid('h_status');
const active=new Map();
pads.forEach(b=>b.addEventListener('click',async ()=>{
  await AudioEngine.resume('pad'); const AC=AudioEngine.AC; if(!AC) return;
  const f=+b.dataset.f, key='f'+f;
  if(active.has(key)){ try{ active.get(key).stop(0); }catch{} active.delete(key); b.classList.remove('on'); status.textContent='Pad off'; return; }
  const o=AC.createOscillator(), g=AC.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=.0001; o.connect(g); g.connect(AudioEngine.master); o.start(); g.gain.linearRampToValueAtTime(.18, AC.currentTime+.2);
  o.onended=()=>active.delete(key); active.set(key,o); b.classList.add('on'); status.textContent='Playing '+f+' Hz';
}));
stopB.onclick=()=>{ active.forEach(n=>{try{n.stop(0)}catch{}}); active.clear(); pads.forEach(p=>p.classList.remove('on')); status.textContent='Stopped'; };
(function viz(){ const W=cvs.clientWidth,H=cvs.clientHeight; ctx.fillStyle='#050912'; ctx.fillRect(0,0,W,H); const t=Date.now()/1000; const r=60+Math.sin(t*0.6)*20; ctx.strokeStyle='rgba(98,211,255,.6)'; ctx.beginPath(); ctx.arc(W/2,H/2,r,0,Math.PI*2); ctx.stroke(); requestAnimationFrame(viz);} )();
}

/* ============= Diagnostics ============= */
const dPing=gid('d_ping'), dTri=gid('d_tri'), dStop=gid('d_stop'), dStatus=gid('d_status');
dPing.onclick=async()=>{ const ok=await AudioEngine.resume('diag'); if(ok){ AudioEngine.tone(520,.12,.22,'sine'); dStatus.textContent='Status: ping played'; } else { dStatus.textContent='Status: blocked'; } };
dTri.onclick=async()=>{ const ok=await AudioEngine.resume('diag_tri'); if(ok){ AudioEngine.tone(660,.15,.22,'triangle'); dStatus.textContent='Status: triangle 660Hz'; } else { dStatus.textContent='Status: blocked'; } };
dStop.onclick=()=>{ AudioEngine.stopAll(); dStatus.textContent='Status: stopped'; };

/* default view */
V.hub.classList.add('active');
</script>
</body>
</html>
