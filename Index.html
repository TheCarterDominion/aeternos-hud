<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Aeternos • Safe-Mode v5 (Ultra-Compatible)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root{--ink:#ecf3ff;--mut:#9fb3cc;--a:#62d3ff;--b:#ff49f0;--panel:#0f1a33;--bg1:#060b1c;--bg2:#02040c}
*{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
html,body{height:100%;margin:0;background:radial-gradient(1600px 1000px at 50% 8%,var(--bg1),var(--bg2));color:var(--ink);
  font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;-webkit-text-size-adjust:100%;overscroll-behavior:none}
button{font:inherit;color:inherit}
.app{position:fixed;inset:0;display:flex;flex-direction:column}
.top{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px}
h1{margin:0;font-size:18px;text-shadow:0 0 14px rgba(98,211,255,.6)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{border:2px solid rgba(255,255,255,.8);background:#0b1734;color:var(--ink);padding:12px 14px;border-radius:14px;font-size:16px}
.btn.small{padding:8px 10px;font-size:14px;border-radius:10px}
.pill{border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);font-size:12px}
.panel{flex:1;display:none}
.panel.active{display:block}
.card{height:100%;display:flex;align-items:center;justify-content:center;padding:12px}
.box{width:100%;max-width:1100px;background:var(--panel);border:1px solid rgba(255,255,255,.15);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45);padding:14px}
.frame{width:100%;height:420px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:#050912;position:relative;overflow:hidden}
canvas{display:block;width:100%;height:100%;background:#050912;border-radius:12px;touch-action:manipulation}
.badge{position:absolute;top:8px;left:8px;background:rgba(98,211,255,.14);border:1px solid rgba(98,211,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}
.mut{color:var(--mut);font-size:12px}
.gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#07122b,#050912 60%);z-index:9999}
.gate_inner{max-width:560px;text-align:center;border:1px solid rgba(255,255,255,.15);background:#0f1a33;border-radius:18px;padding:18px;box-shadow:0 12px 36px rgba(0,0,0,.5)}
.ok{color:#5cffb1}.warn{color:#ffd76a}.err{color:#ff6b6b}
</style>
</head>
<body ontouchstart="">
<div class="app">
  <div class="top">
    <h1>Aeternos — Safe-Mode v5</h1>
    <div class="row">
      <button class="btn small" id="nav_hub" onclick="show('hub')">Hub</button>
      <button class="btn small" id="nav_runner" onclick="show('runner')">Runner</button>
      <button class="btn small" id="nav_healing" onclick="show('healing')">Healing</button>
      <button class="btn small" id="nav_diag" onclick="show('diag')">Diagnostics</button>
    </div>
    <div class="row">
      <button class="btn small" id="btn_stop" onclick="Audio.stopAll()">Stop All</button>
      <span class="pill" id="audio_state">Audio: Off</span>
      <span class="pill" id="evt_state">Last event: —</span>
    </div>
  </div>

  <!-- HUB -->
  <section id="v-hub" class="panel active">
    <div class="card"><div class="box">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <button class="btn" id="btn_enable" onclick="enableAudio()">Enable Audio</button>
            <button class="btn" id="btn_beep" onclick="beep()">Beep</button>
            <button class="btn" id="btn_click" onclick="eventTest()">Touch Test</button>
          </div>
          <div class="mut" style="margin-top:8px">Tap one of these **big buttons**. If they react, touch works at the OS/browser level.</div>
          <div class="mut">If **Enable Audio** changes the badge and Beep makes a sound, audio is unlocked.</div>
        </div>
        <div>
          <div class="pill">Device: <b id="ua_short">—</b></div>
          <div class="pill">PointerEvents: <b id="pe_ok">—</b></div>
          <div class="pill">Touch: <b id="touch_ok">—</b></div>
          <div class="pill">Clicks: <b id="clicks_ok">—</b></div>
        </div>
      </div>
      <div class="frame" style="margin-top:12px">
        <div class="badge">Canvas Touch Panel</div>
        <canvas id="touch_canvas" height="420"></canvas>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="pill">Touches <b id="t_count">0</b></span>
        <span class="pill">Last <b id="t_last">—</b></span>
      </div>
    </div></div>
  </section>

  <!-- RUNNER -->
  <section id="v-runner" class="panel">
    <div class="card"><div class="box">
      <div class="row" style="margin-bottom:8px">
        <span class="pill">Score <b id="r_score">0</b></span>
        <span class="pill">Shield <b id="r_shield">100%</b></span>
        <button class="btn small" onclick="runnerPause()" id="r_pause">Pause</button>
        <button class="btn small" onclick="runnerReset()" id="r_reset">Restart</button>
        <span class="mut">Tap to jump • swipe down to duck</span>
      </div>
      <div class="frame"><div class="badge">Pulse Runner — v5</div><canvas id="r_canvas" height="420"></canvas></div>
    </div></div>
  </section>

  <!-- HEALING -->
  <section id="v-healing" class="panel">
    <div class="card"><div class="box">
      <div class="row" style="margin-bottom:8px">
        <button class="btn small" ontouchstart="pad(396)" onclick="pad(396)">396</button>
        <button class="btn small" ontouchstart="pad(432)" onclick="pad(432)">432</button>
        <button class="btn small" ontouchstart="pad(528)" onclick="pad(528)">528</button>
        <button class="btn small" ontouchstart="pad(639)" onclick="pad(639)">639</button>
        <button class="btn small" onclick="padsStop()">Stop Pads</button>
        <span class="pill">Status: <b id="h_status">Idle</b></span>
      </div>
      <div class="frame"><div class="badge">Sound Healing — v5</div><canvas id="h_canvas" height="420"></canvas></div>
    </div></div>
  </section>

  <!-- DIAGNOSTICS -->
  <section id="v-diag" class="panel">
    <div class="card"><div class="box">
      <div class="row" style="margin-bottom:8px">
        <button class="btn small" onclick="enableAudio(true)">Enable (force)</button>
        <button class="btn small" onclick="beep()">Ping Tone</button>
        <button class="btn small" onclick="Audio.stopAll()">Stop All</button>
      </div>
      <pre id="diag" style="background:#0b1734;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;height:240px;overflow:auto;font-family:ui-monospace,Consolas,Menlo,monospace"></pre>
      <div class="mut">If Ping is silent on iPad/Note8, tap **Enable (force)**, then Ping again.</div>
    </div></div>
  </section>
</div>

<!-- Fullscreen gate that also uses inline handlers (works on ancient touch stacks) -->
<div id="gate" class="gate" role="button" aria-label="Tap to Start" onclick="startGate()" ontouchstart="startGate()">
  <div class="gate_inner">
    <h2>Tap to Start</h2>
    <p>This unlocks audio and confirms input on iPad/Android.</p>
    <button class="btn" onclick="startGate()" ontouchstart="startGate()">Start</button>
    <p class="mut">If you see this again after reload, just tap once.</p>
  </div>
</div>

<!-- HTML <audio> fallback clip (very short click) -->
<audio id="html_click" preload="auto">
  <!-- 1kHz 50ms mono WAV (base64) -->
  <source src="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAlAAAAPwAAABkAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==" type="audio/wav">
</audio>

<script>
/* ========= Mini utilities ========= */
function gid(x){return document.getElementById(x)}
function log(s){ const d=gid('diag'); d.textContent += s + "\\n"; d.scrollTop = d.scrollHeight; }
function setEvent(name){ gid('evt_state').textContent = 'Last event: '+name; }

/* ========= Show/hide panels (no dependency on pointer events) ========= */
const Views={hub:gid('v-hub'),runner:gid('v-runner'),healing:gid('v-healing'),diag:gid('v-diag')};
function show(name){ Object.values(Views).forEach(v=>v.classList.remove('active')); Views[name].classList.add('active'); if(name==='runner' && !Runner.booted) Runner.boot(); if(name==='healing' && !Healing.booted) Healing.boot(); }

/* ========= Ultra-compatible Audio (WebAudio + HTML <audio> unlock) ========= */
const Audio=(function(){
  let AC=null, master=null, unlocked=false;
  const live=new Set();
  function badge(){ gid('audio_state').textContent = unlocked ? 'Audio: On' : (AC ? 'Audio: '+AC.state : 'Audio: Off'); }
  function ensure(){ if(AC) return; const C=window.AudioContext||window.webkitAudioContext; if(!C) return; AC=new C({latencyHint:'interactive'}); master=AC.createGain(); master.gain.value=.7; master.connect(AC.destination); }
  async function unlock(tag){
    try{
      ensure();
      // First try HTML audio (works even if WebAudio is stubborn)
      const html=gid('html_click'); if(html){ try{ await html.play(); html.pause(); html.currentTime=0; }catch(e){/* ignore */} }
      if(AC){ if(AC.state!=='running'){ await AC.resume(); } // some browsers need resume after a real user gesture
        // play a near-inaudible tone to cement unlock
        const o=AC.createOscillator(), g=AC.createGain(); g.gain.value=0.0001; o.connect(g); g.connect(master); o.start(); o.stop(AC.currentTime+0.04); }
      unlocked = AC ? (AC.state==='running') : (!!html);
    }catch(e){ unlocked=false; }
    badge(); log('unlock('+tag+'): '+(unlocked?'OK':'blocked'));
    return unlocked;
  }
  function tone(f=440,d=.15,v=.22,type='sine'){ if(!unlocked||!AC) return; const t=AC.currentTime, o=AC.createOscillator(), g=AC.createGain();
    o.type=type; o.frequency.value=f; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(v,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g); g.connect(master); o.start(t); o.stop(t+d+.02); live.add(o); o.onended=()=>live.delete(o); }
  function stopAll(){ live.forEach(n=>{try{n.stop(0)}catch{}}); live.clear(); log('Stop All'); }
  // attach many unlock routes
  ['click','touchstart','mousedown','keydown'].forEach(ev=>{
    window.addEventListener(ev,()=>unlock(ev),{passive:true});
  });
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') unlock('visible'); });
  badge();
  return {unlock,tone,stopAll,get AC(){return AC}};
})();

/* ========= Gate ========= */
async function startGate(){
  setEvent('gate-tap');
  await Audio.unlock('gate');
  try{ Audio.tone(660,.08,.18,'triangle'); setTimeout(()=>Audio.tone(880,.08,.16,'sine'),90); }catch{}
  gid('gate').style.display='none';
}

/* ========= HUB: big buttons + canvas touch panel ========= */
function enableAudio(){ Audio.unlock('enable-btn'); }
function beep(){ setEvent('beep'); Audio.tone(740,.12,.22,'sine'); }
function eventTest(){ setEvent('click/tap'); }
;(function hub(){
  gid('ua_short').textContent = (navigator.userAgent||'UA').slice(0,45)+'…';
  gid('pe_ok').textContent = ('PointerEvent' in window) ? 'yes' : 'no';
  gid('touch_ok').textContent = ('ontouchstart' in window) ? 'yes' : 'no';
  gid('clicks_ok').textContent = ('onclick' in document.createElement('button')) ? 'yes' : 'no';
  const c=gid('touch_canvas'), ctx=c.getContext('2d',{alpha:false}); ctx.fillStyle='#050912'; ctx.fillRect(0,0,c.width,c.height);
  let count=0;
  function dot(x,y,label){
    ctx.fillStyle='#62d3ff'; ctx.beginPath(); ctx.arc(x,y,8,0,Math.PI*2); ctx.fill();
    gid('t_count').textContent=''+(++count); gid('t_last').textContent=label;
  }
  function rel(e){ const r=c.getBoundingClientRect(); return {x:(e.clientX||0)-r.left, y:(e.clientY||0)-r.top}; }
  c.addEventListener('touchstart',e=>{ const t=e.changedTouches&&e.changedTouches[0]; if(!t) return; const r=c.getBoundingClientRect(); dot(t.clientX-r.left,t.clientY-r.top,'touchstart'); e.preventDefault(); },{passive:false});
  c.addEventListener('mousedown',e=>{ const p=rel(e); dot(p.x,p.y,'mousedown'); });
  c.addEventListener('click',e=>{ const p=rel(e); dot(p.x,p.y,'click'); });
})();

/* ========= RUNNER (simple & stable) ========= */
const Runner=(function(){
  let booted=false, paused=false, over=false, score=0, shield=100, startY=null;
  let ply={x:120,y:0,w:44,h:56,vy:0,ground:0,duck:0};
  const GRAV=1.0, HOLD=.35, J=-32, obs=[];
  const c=gid('r_canvas'), ctx=c.getContext('2d',{alpha:false});
  function W(){return c.clientWidth||600} function H(){return c.clientHeight||300}
  function reset(){ over=false; paused=false; score=0; shield=100; ply.h=56; ply.ground=(H()-98)|0; ply.y=ply.ground-ply.h; ply.vy=0; ply.duck=0;
    gid('r_score').textContent='0'; gid('r_shield').textContent='100%'; obs.length=0; }
  function jump(){ if(over) return; if(ply.y>=ply.ground-ply.h-0.1){ ply.vy=J; Audio.tone(620,.1,.2,'triangle'); } }
  function duck(){ if(over) return; if(ply.duck>0) return; const feet=ply.y+ply.h; ply.h=32; ply.y=feet-ply.h; ply.duck=18; Audio.tone(480,.06,.16,'square'); }
  function spawn(){ const g=ply.ground; if(Math.random()<0.6) obs.push({x:W()+40,y:g-28,w:28,h:28}); else obs.push({x:W()+40,y:g-60,w:28,h:60}); }
  let cd=0;
  function step(){
    if(paused||over) return;
    ply.vy += (ply.vy<0)?HOLD:GRAV; ply.y += ply.vy;
    if(ply.y>ply.ground-ply.h){ ply.y=ply.ground-ply.h; ply.vy=0; if(ply.duck>0){ ply.duck--; if(ply.duck===0){ const feet=ply.y+ply.h; ply.h=56; ply.y=feet-ply.h; } } }
    if(--cd<=0){ cd=82; spawn(); }
    for(let i=obs.length-1;i>=0;i--){ const o=obs[i]; o.x-=6.2; if(o.x+o.w<-20){ obs.splice(i,1); score++; gid('r_score').textContent=''+score; } }
    const b={x:ply.x+3,y:ply.y+(ply.duck?8:4),w:ply.w-6,h:(ply.duck?32:ply.h-8)};
    for(const o of obs){ if(o.x<b.x+b.w && o.x+o.w>b.x && o.y<b.y+b.h && o.y+o.h>b.y){ shield=Math.max(0,shield-34); gid('r_shield').textContent=shield+'%'; Audio.tone(220,.12,.22,'square'); if(shield<=0) over=true; } }
  }
  function draw(){
    const w=W(),h=H(); ctx.fillStyle='#050912'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='rgba(255,255,255,.1)'; ctx.fillRect(0,Math.floor(ply.ground+2)+.5,w,2);
    ctx.fillStyle='#ff49f0'; for(const o of obs){ ctx.fillRect(o.x|0,o.y|0,o.w|0,o.h|0); }
    ctx.fillStyle='#62d3ff'; ctx.fillRect(ply.x|0,ply.y|0,(ply.w)|0,(ply.duck?32:ply.h)|0);
    if(over){ ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,w,h); ctx.fillStyle='#ecf3ff'; ctx.font='18px -apple-system,system-ui'; ctx.fillText('Game Over — tap Restart',12,24); }
  }
  function loop(){ step(); draw(); requestAnimationFrame(loop); }
  function bindInputs(){
    c.addEventListener('touchstart',e=>{ const t=e.changedTouches&&e.changedTouches[0]; if(!t) return; jump(); startY=t.clientY; e.preventDefault(); },{passive:false});
    c.addEventListener('touchmove',e=>{ const t=e.changedTouches&&e.changedTouches[0]; if(startY!=null && t && t.clientY-startY>60){ duck(); startY=null; } },{passive:true});
    c.addEventListener('touchend',()=>{ startY=null; },{passive:true});
    c.addEventListener('mousedown',()=>{ jump(); });
    window.addEventListener('mousemove',()=>{}, {passive:true}); // keeps some mobile browsers “awake”
  }
  function boot(){ if(booted) return; booted=true; reset(); bindInputs(); loop(); }
  return {booted,boot,reset, pause(){paused=!paused;}, hardReset:reset};
})();
function runnerPause(){ Runner.pause(); gid('r_pause').textContent = gid('r_pause').textContent==='Pause'?'Resume':'Pause'; }
function runnerReset(){ Runner.hardReset(); }

/* ========= HEALING ========= */
const Healing=(function(){
  let booted=false; const active=new Map();
  const c=gid('h_canvas'), ctx=c.getContext('2d',{alpha:false});
  function viz(){ const W=c.clientWidth||600,H=c.clientHeight||300; ctx.fillStyle='#050912'; ctx.fillRect(0,0,W,H); const t=Date.now()/1000; const r=60+Math.sin(t*0.6)*20; ctx.strokeStyle='rgba(98,211,255,.6)'; ctx.beginPath(); ctx.arc(W/2,H/2,r,0,Math.PI*2); ctx.stroke(); requestAnimationFrame(viz);}
  function boot(){ if(booted) return; booted=true; viz(); }
  function toggle(f){
    Audio.unlock('pad');
    const key='f'+f;
    if(active.has(key)){ try{active.get(key)()}catch{} active.delete(key); gid('h_status').textContent='Pad off'; return; }
    // start osc + provide stopper
    try{
      const AC=Audio.AC; if(!AC){ gid('h_status').textContent='No AudioContext'; return; }
      const o=AC.createOscillator(), g=AC.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=.0001; o.connect(g); g.connect(AC.destination); o.start(); g.gain.linearRampToValueAtTime(.18, AC.currentTime+.2);
      const stop=()=>{ try{o.stop(0)}catch{} }; o.onended=()=>active.delete(key); active.set(key,stop); gid('h_status').textContent='Playing '+f+' Hz';
    }catch(e){ gid('h_status').textContent='Audio error'; }
  }
  function stopAll(){ active.forEach(fn=>{try{fn()}catch{}}); active.clear(); gid('h_status').textContent='Stopped'; }
  return {booted,boot,toggle,stopAll};
})();
function pad(f){ Healing.toggle(f); }
function padsStop(){ Healing.stopAll(); }

/* ========= Quick listeners for event monitor ========= */
['click','touchstart','mousedown','keydown'].forEach(ev=>{
  window.addEventListener(ev,()=>setEvent(ev),{passive:true});
});
</script>
</body>
</html>
