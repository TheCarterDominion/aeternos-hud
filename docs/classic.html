<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>Aeternos • Classic (Silk Diagnostic)</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#04102a;color:#ecf3ff}
  main{max-width:820px;margin:24px auto;padding:16px}
  button{padding:14px 16px;border:2px solid #8cc2ff;border-radius:12px;background:#0b1734;color:#ecf3ff;font-size:16px;margin:6px 8px 6px 0}
  .pill{display:inline-block;border:1px solid #6e87b8;border-radius:999px;padding:6px 10px;margin:6px 8px 6px 0}
  #pad{height:40vh;border:2px dashed #7aa2e3;border-radius:14px;margin-top:10px;display:flex;align-items:center;justify-content:center}
  #log{white-space:pre-wrap;background:#0b1734;border:1px solid rgba(255,255,255,.25);padding:10px;border-radius:12px;margin-top:12px;max-height:30vh;overflow:auto}
</style>
</head>
<body>
<main>
  <h1>Classic (Silk Diagnostic)</h1>
  <div>
    <button id="btn-enable">Enable Audio</button>
    <button id="btn-beep">Beep</button>
    <span class="pill" id="state">Audio: Off</span>
  </div>
  <div>
    <button id="btn-tap">Tap Counter</button>
    <span class="pill">Taps: <b id="count">0</b></span>
    <span class="pill">Last: <b id="last">—</b></span>
  </div>
  <div id="pad">Tap inside this area</div>

  <!-- Simple HTML audio (no WebAudio) -->
  <audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAlAAAAPwAAABkAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==" type="audio/wav">
  </audio>

  <div id="log" aria-live="polite"></div>
</main>

<script>
(function(){
  function $(id){return document.getElementById(id);}
  var state=$('state'), last=$('last'), cnt=$('count'), pad=$('pad'), logEl=$('log'), taps=0;
  var B=$('beep');

  function log(msg){
    var t = new Date().toLocaleTimeString();
    logEl.textContent += "["+t+"] "+msg+"\n";
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setLast(x){ if(last) last.textContent = x; }

  // Counter
  function bump(){ taps++; if(cnt) cnt.textContent = String(taps); }
  // Bind both touchstart (with preventDefault) and click for Silk
  function bindTap(el, fn){
    if(!el) return;
    el.addEventListener('touchstart', function(e){ fn(); e.preventDefault(); }, {passive:false});
    el.addEventListener('click', fn);
  }

  bindTap($('btn-tap'), bump);
  if(pad){
    pad.addEventListener('touchstart', function(e){ bump(); setLast('touchstart-pad'); e.preventDefault(); }, {passive:false});
    pad.addEventListener('click', function(){ bump(); setLast('click-pad'); });
    pad.addEventListener('mousedown', function(){ bump(); setLast('mousedown-pad'); });
  }

  // Audio unlock: try to play/pause the HTML audio
  function enableAudio(){
    if(!B){ log("No <audio> element present"); return; }
    try{
      B.currentTime = 0;
      var p = B.play();
      if(p && typeof p.then === 'function'){
        p.then(function(){
          B.pause();
          state.textContent = "Audio: On";
          log("Audio unlocked via HTML <audio>.");
        }).catch(function(err){
          log("play() rejected: "+err);
          state.textContent = "Audio: Off";
        });
      }else{
        // Older browsers may not return a promise
        state.textContent = "Audio: On (no-promise)";
        log("Audio unlocked (no promise).");
      }
    }catch(e){
      log("Enable error: "+e);
    }
  }

  function beep(){
    if(!B){ log("No <audio> element present"); return; }
    try{
      B.currentTime = 0;
      var p = B.play();
      if(p && typeof p.catch === 'function'){
        p.catch(function(err){ log("Beep play() error: "+err); });
      }
    }catch(e){ log("Beep error: "+e); }
  }

  bindTap($('btn-enable'), enableAudio);
  bindTap($('btn-beep'), beep);

  // Global listeners for visibility/touch to see what Silk fires
  ['pointerdown','click','touchstart','keydown','visibilitychange'].forEach(function(ev){
    window.addEventListener(ev,function(){ setLast(ev); log("Event: "+ev); }, {passive:true});
  });

  log("Ready. Tap 'Enable Audio' once, then 'Beep'.");
})();
</script>
</body>
</html>
      state=document.getElementById('state'), pad=document.getElementById('pad'),
      banner=document.getElementById('unlock'), html=document.getElementById('htmlBeep');

  function setLast(x){ if(last) last.textContent = x; }
  function count(){ taps++; if(out) out.textContent = String(taps); }

  // Attach listeners (no inline attrs)
  ['pointerdown','click','touchstart','keydown'].forEach(function(ev){
    window.addEventListener(ev,function(){ setLast(ev); unlockAudio(); }, {passive:true});
  });
  if(document.getElementById('btn-tap')) {
    document.getElementById('btn-tap').addEventListener('click', count);
  }
  if(pad){
    pad.addEventListener('touchstart', function(e){ count(); e.preventDefault(); }, {passive:false});
    pad.addEventListener('click', count);
    pad.addEventListener('mousedown', count);
  }

  // Audio
  var AC=null, master=null, unlocked=false;
  function badge(){
    if(state) state.textContent = unlocked ? 'Audio: On' : (AC ? ('Audio: '+AC.state) : 'Audio: Off');
    if(banner) banner.style.display = unlocked ? 'none' : 'block';
  }
  function ensure(){
    if(AC) return;
    var C = window.AudioContext || window.webkitAudioContext;
    if(!C) return;
    try{
      AC = new C({latencyHint:'interactive'});
      master = AC.createGain(); master.gain.value = 0.7; master.connect(AC.destination);
    }catch(e){ AC=null; }
  }
  async function unlockAudio(){
    if(unlocked) return;
    try{ if(html){ try{ html.currentTime=0; await html.play(); html.pause(); }catch(e){} } }catch(e){}
    ensure();
    if(AC && AC.state !== 'running'){ try{ await AC.resume(); }catch(e){} }
    if(AC){ try{ var o=AC.createOscillator(), g=AC.createGain(); g.gain.value=0.0001; o.connect(g); g.connect(master); o.start(); o.stop(AC.currentTime+0.04);}catch(e){} }
    unlocked = AC ? (AC.state === 'running') : !!html;
    badge();
  }
  function beep(){
    if(AC && unlocked){
      var t=AC.currentTime, o=AC.createOscillator(), g=AC.createGain();
      o.type='sine'; o.frequency.value=660;
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(.22,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.15);
      o.connect(g); g.connect(master); o.start(t); o.stop(t+.18);
    } else if(html){
      try{ html.currentTime=0; html.play(); }catch(e){}
    }
  }

  var btnEnable = document.getElementById('btn-enable');
  var btnBeep = document.getElementById('btn-beep');
  if(btnEnable) btnEnable.addEventListener('click', unlockAudio);
  if(btnBeep)   btnBeep.addEventListener('click', beep);

  badge();
})();
</script>
</body>
</html>
