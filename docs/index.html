<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,maximum-scale=1"/>
<title>Aeternos Arcade — City of Light (One File)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root{
  --ink:#ecf3ff; --mut:#9fb3cc; --a:#62d3ff; --b:#ff49f0; --gold:#ffd76a;
  --panel:#0f1a33; --bg1:#060a16; --bg2:#02040a; --glow:rgba(98,211,255,.6)
}
html,body{margin:0;height:100%;background:radial-gradient(1600px 1000px at 50% 8%,var(--bg1),var(--bg2));color:var(--ink);
  font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;-webkit-text-size-adjust:100%;overscroll-behavior:none;overflow:hidden}
*{touch-action:manipulation}
.app{position:fixed;inset:0;height:100dvh;display:flex;flex-direction:column}
.top{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:10px}
h1{margin:0;font-size:20px;text-shadow:0 0 18px var(--glow)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:2px solid rgba(255,255,255,.7);background:transparent;color:var(--ink);padding:9px 12px;border-radius:12px;font-size:15px;text-decoration:none}
.pill{border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);font-size:13px}
.panel{flex:1;display:none}
.panel.active{display:block}
.card{height:100%;display:flex;align-items:center;justify-content:center;padding:16px}
.box{width:100%;max-width:1100px;background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45);padding:16px}

/* Hub grid */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:8px}
.tile{position:relative;background:#091024;border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
.hero{height:160px;position:relative}
.fx{position:absolute;inset:0;background:
  radial-gradient(rgba(255,255,255,.12) 1px,transparent 2px),
  linear-gradient(90deg, rgba(98,211,255,.18), transparent 60%);
  background-size:26px 26px,100% 100%;animation:par 12s linear infinite}
@keyframes par{from{background-position:0 0,0 0}to{background-position:-1600px 0,0 0}}
.tile .title{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;gap:10px}
.mut{color:var(--mut);font-size:13px}

/* Game frames */
.frame{width:100%;height:380px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:#050912;position:relative;overflow:hidden}
canvas{display:block;width:100%;height:100%;background:#050912;border-radius:12px;touch-action:none}
.scan{position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;background:
  repeating-linear-gradient(180deg, rgba(255,255,255,.05) 0 1px, transparent 1px 3px)}
.flash{position:fixed;inset:0;pointer-events:none;background:rgba(255,70,70,.28);opacity:0;transition:opacity .12s ease}
.flash.on{opacity:1}
.badge{position:absolute;top:8px;left:8px;background:rgba(98,211,255,.14);border:1px solid rgba(98,211,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}

/* Tiny HUD rows */
.hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px 0}

/* Faith bar */
.faith{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06)}
.faith .cross{width:12px;height:12px;border:2px solid #fff;border-radius:2px;position:relative;opacity:.9}
.faith .cross:before{content:"";position:absolute;left:50%;top:-3px;transform:translateX(-50%);width:2px;height:18px;background:#fff;border-radius:1px}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <h1>Aeternos Arcade — City of Light</h1>
    <div class="nav">
      <button class="btn" data-view="hub">Hub</button>
      <button class="btn" data-view="slice">Slice</button>
      <button class="btn" data-view="runner">Runner</button>
    </div>
  </div>

  <!-- HUB -->
  <section id="view-hub" class="panel active">
    <div class="card"><div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <div style="font-weight:700;font-size:18px">Choose a game</div>
          <div class="mut">Single file • iPad-safe • Touch-first • Upgraded neon art & a City of Light.</div>
        </div>
        <div>
          <span class="pill">Vector sprites</span>
          <span class="pill">Crisp edges</span>
          <span class="pill">Arcade vibe</span>
        </div>
      </div>
      <div class="grid">
        <div class="tile">
          <div class="hero"><div class="fx"></div></div>
          <div class="title">
            <div><div style="font-weight:600">Slice • Neon Shards</div><div class="mut">Tap to slice • Combos • Particles • Glow</div></div>
            <button class="btn" data-view="slice">Play</button>
          </div>
        </div>
        <div class="tile">
          <div class="hero"><div class="fx" style="opacity:.8"></div></div>
          <div class="title">
            <div><div style="font-weight:600">Pulse Runner — City of Light</div><div class="mut">Hold jump • Duck • Stars/Scrolls • Faith Shield • Halo trail</div></div>
            <button class="btn" data-view="runner">Play</button>
          </div>
        </div>
        <div class="tile" style="opacity:.55">
          <div class="hero"><div class="fx"></div></div>
          <div class="title">
            <div><div style="font-weight:600">Neo Arena (WIP)</div><div class="mut">Dash • Chains • Boss gate</div></div>
            <span class="btn">Locked</span>
          </div>
        </div>
      </div>
    </div></div>
  </section>

  <!-- SLICE -->
  <section id="view-slice" class="panel">
    <div class="card"><div class="box">
      <div class="hud">
        <span class="pill">Score: <b id="s_score">0</b></span>
        <span class="pill">Combo: <b id="s_combo">0x</b></span>
        <span class="pill">FPS: <b id="s_fps">--</b></span>
        <span class="pill">Touches: <b id="s_touch">0</b></span>
        <button class="btn" id="s_pause">Pause</button>
        <button class="btn" id="s_reset">Reset</button>
        <label class="btn" style="display:inline-flex;gap:8px;align-items:center">
          <input id="s_big" type="checkbox" style="position:absolute;left:-9999px">
          <span style="width:10px;height:10px;border-radius:50%;background:#4a5568;display:inline-block" id="s_dot"></span>
          Big Targets
        </label>
      </div>
      <div class="frame">
        <div class="badge">Neon Slice</div>
        <canvas id="s_canvas" height="380"></canvas>
        <div class="scan"></div>
      </div>
      <div class="mut" style="margin-top:10px">Tap near a neon shard to slice it. Miss = red flash & combo reset. Tap after Game Over = restart.</div>
    </div></div>
  </section>

  <!-- RUNNER -->
  <section id="view-runner" class="panel">
    <div class="card"><div class="box">
      <div class="hud">
        <span class="pill">Score <b id="r_score">0</b></span>
        <span class="pill">Stars <b id="r_coins">0</b></span>
        <span class="pill">Speed <b id="r_spd">1.0x</b></span>
        <span class="pill">FPS <b id="r_fps">--</b></span>
        <span class="faith"><span class="cross"></span> Faith Shield <b id="r_shield">100%</b></span>
        <button class="btn" id="r_audio">Enable Audio</button>
        <button class="btn" id="r_duck">Duck</button>
        <button class="btn" id="r_pause">Pause</button>
        <button class="btn" id="r_reset">Restart</button>
      </div>
      <div class="frame">
        <div class="badge">Pulse Runner — City of Light</div>
        <canvas id="r_canvas" height="380"></canvas>
        <div class="scan"></div>
      </div>
      <div class="mut" style="margin-top:10px">Hold to extend jump. Swipe-down or tap Duck. Tap after Game Over = restart.</div>
    </div></div>
  </section>
</div>
<div class="flash" id="flash"></div>

<script>
/* ========== ROUTER ========== */
const views={hub:gid('view-hub'),slice:gid('view-slice'),runner:gid('view-runner')};
qa('[data-view]').forEach(b=>b.addEventListener('click',()=>show(b.dataset.view)));
function show(name){ Object.values(views).forEach(v=>v.classList.remove('active')); views[name].classList.add('active'); if(name==='slice') bootSlice(); if(name==='runner') bootRunner(); setTimeout(()=>dispatchEvent(new Event('resize')),0); }
function gid(id){return document.getElementById(id)} function qa(s){return document.querySelectorAll(s)}
const flashEl=gid('flash'); function flash(){ flashEl.classList.add('on'); setTimeout(()=>flashEl.classList.remove('on'),120); }

/* ========== SHARED NEON HELPERS ========== */
function setupCanvas(cvs){
  const ctx=cvs.getContext('2d',{alpha:false});
  // crisp edges
  ctx.imageSmoothingEnabled=false;
  let DPR=Math.max(1,Math.min(3,devicePixelRatio||1));
  function resize(){ const w=cvs.clientWidth,h=cvs.clientHeight; cvs.width=(w*DPR)|0; cvs.height=(h*DPR)|0; ctx.setTransform(DPR,0,0,DPR,0,0); }
  new ResizeObserver(resize).observe(cvs); resize();
  return {ctx, DPR, resize};
}
function lineSnap(n){ return (n|0)+0.5 } // pixel snap for crisp strokes
function neonRect(ctx,x,y,w,h,from='#62d3ff',to='#ff49f0',alpha=1){
  const g=ctx.createLinearGradient(x,y,x,y+h); g.addColorStop(0,from); g.addColorStop(1,to);
  ctx.save(); ctx.globalAlpha=alpha; ctx.fillStyle=g; ctx.fillRect(x|0,y|0,w|0,h|0);
  ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.strokeRect(lineSnap(x-0.5),lineSnap(y-0.5),(w+1)|0,(h+1)|0); ctx.restore();
}
function star(ctx,cx,cy,r,rot=0){
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(rot);
  ctx.beginPath();
  for(let i=0;i<10;i++){
    const ang=Math.PI*i/5; const rr=(i%2==0)?r:r*0.45;
    ctx.lineTo(Math.cos(ang)*rr, Math.sin(ang)*rr);
  }
  ctx.closePath(); ctx.fillStyle='#ffd76a'; ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.55)'; ctx.stroke();
  ctx.restore();
}
function wing(ctx,cx,cy,flip=1){
  ctx.save(); ctx.translate(cx,cy); ctx.scale(flip,1);
  ctx.beginPath();
  ctx.moveTo(0,0); ctx.quadraticCurveTo(18,-8,34,-2); ctx.quadraticCurveTo(18,2,0,0);
  ctx.fillStyle='rgba(236,243,255,.75)'; ctx.fill();
  ctx.restore();
}
function halo(ctx,cx,cy,r){ ctx.save(); ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=2; ctx.beginPath(); ctx.ellipse(cx,cy,r, r*0.35, 0, 0, Math.PI*2); ctx.stroke(); ctx.restore(); }
function trail(ctx,pts,col='rgba(98,211,255,.35)'){
  if(pts.length<2) return; ctx.save(); ctx.fillStyle=col;
  for(let i=1;i<pts.length;i++){
    const a=pts[i-1], b=pts[i], dx=b.x-a.x, dy=b.y-a.y, len=Math.hypot(dx,dy)||1, nx=-dy/len*4, ny=dx/len*4;
    ctx.globalAlpha=(i/pts.length)*0.7;
    ctx.beginPath(); ctx.moveTo(a.x+nx,a.y+ny); ctx.lineTo(a.x-nx,a.y-ny); ctx.lineTo(b.x-nx,b.y-ny); ctx.lineTo(b.x+nx,b.y+ny); ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}

/* ===================== SLICE (NEON SHARDS) ===================== */
let sliceBooted=false;
function bootSlice(){ if(sliceBooted) return; sliceBooted=true;
const cvs=gid('s_canvas'); const {ctx}=setupCanvas(cvs);
const el={score:gid('s_score'), combo:gid('s_combo'), fps:gid('s_fps'), touch:gid('s_touch'), pause:gid('s_pause'), reset:gid('s_reset'), big:gid('s_big'), dot:gid('s_dot')};
let paused=false, gameOver=false, last=performance.now(), frames=0, acc=0, score=0, touches=0, combo=0, lastHitAt=0;
const shards=[], fx=[];
function seed(){ shards.length=0; fx.length=0; const W=cvs.width, H=cvs.height; for(let i=0;i<36;i++) shards.push({x:Math.random()*(W/2),y:Math.random()*(H/2),w:14+Math.random()*18,s:0.6+Math.random()*1.8,d:Math.random()<.5?-1:1}); score=0;touches=0;combo=0;lastHitAt=0;el.score.textContent='0';el.touch.textContent='0';el.combo.textContent='0x';gameOver=false; }
seed();
function step(dt){ if(paused||gameOver) return; const W=cvs.width/ (window.devicePixelRatio||1), H=cvs.height/(window.devicePixelRatio||1);
  for(const s of shards){ s.x -= s.s*46*dt/1000; if(s.x<-s.w){ s.x=W+24; s.y=Math.random()*H; s.w=14+Math.random()*18; s.s=0.6+Math.random()*1.8; s.d = Math.random()<.5?-1:1; } }
  for(let i=fx.length-1;i>=0;i--){ const p=fx[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.14; p.life--; if(p.life<=0) fx.splice(i,1); }
}
function draw(){ const W=cvs.width/(window.devicePixelRatio||1), H=cvs.height/(window.devicePixelRatio||1);
  // crisp background grid
  ctx.fillStyle='#050912'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(98,211,255,.08)'; ctx.lineWidth=1;
  for(let x=0;x<W;x+=24){ ctx.beginPath(); ctx.moveTo(lineSnap(x),0); ctx.lineTo(lineSnap(x),H); ctx.stroke(); }
  for(let y=0;y<H;y+=24){ ctx.beginPath(); ctx.moveTo(0,lineSnap(y)); ctx.lineTo(W,lineSnap(y)); ctx.stroke(); }
  // shards
  for(const s of shards){
    const g=ctx.createLinearGradient(s.x,s.y-2,s.x+s.w,s.y+2); g.addColorStop(0,'#62d3ff'); g.addColorStop(1,'#ff49f0');
    ctx.fillStyle=g; ctx.save(); ctx.translate(0,0); ctx.rotate(0);
    ctx.beginPath(); ctx.moveTo(s.x|0, (s.y|0)); ctx.lineTo((s.x+s.w*0.7)|0, (s.y-2)|0); ctx.lineTo((s.x+s.w)|0, (s.y|0)); ctx.lineTo((s.x+s.w*0.7)|0, (s.y+2)|0); ctx.closePath(); ctx.fill(); ctx.restore();
  }
  ctx.fillStyle='rgba(255,73,240,.95)'; for(const p of fx){ ctx.fillRect(p.x|0,p.y|0,2,2); }
  if(gameOver){ ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#ecf3ff'; ctx.font='18px -apple-system,system-ui,Segoe UI'; ctx.fillText('Game Over — Tap to Restart',12,24); }
}
function loop(ts){ const dt=ts-last; last=ts; step(dt); draw(); frames++; acc+=dt; if(acc>500){ el.fps.textContent=String(Math.round(1000/(acc/frames))); frames=0; acc=0; } requestAnimationFrame(loop);} requestAnimationFrame(loop);
function sliceAt(x,y){ const R=el.big.checked?28:18; let hits=0; for(let i=shards.length-1;i>=0;i--){ const s=shards[i], cx=s.x+s.w*0.6, cy=s.y; const dx=cx-x, dy=cy-y; if(dx*dx+dy*dy<=R*R){ for(let k=0;k<18;k++) fx.push({x:cx,y:cy,vx:(Math.random()-0.5)*3,vy:(Math.random()-1.2)*3,life:30}); shards.splice(i,1); hits++; } }
  const W=cvs.width/(window.devicePixelRatio||1), H=cvs.height/(window.devicePixelRatio||1); for(let j=0;j<hits;j++){ shards.push({x:W+24,y:Math.random()*H,w:14+Math.random()*18,s:0.6+Math.random()*1.8,d:Math.random()<.5?-1:1}); }
  return hits;
}
cvs.addEventListener('pointerdown',e=>{ if(gameOver){ seed(); return; } touches++; el.touch.textContent=String(touches); const r=cvs.getBoundingClientRect(), hits=sliceAt(e.clientX-r.left,e.clientY-r.top);
  if(hits>0){ const now=performance.now(); combo=(now-lastHitAt<=1200)?combo+1:1; lastHitAt=now; score+=hits*Math.max(1,combo); el.score.textContent=String(score); el.combo.textContent=combo+'x'; }
  else { combo=0; el.combo.textContent='0x'; flash(); }
  e.preventDefault();
},{passive:false});
el.pause.onclick=()=>{ if(gameOver){ seed(); return; } paused=!paused; el.pause.textContent=paused?'Resume':'Pause'; };
el.reset.onclick=()=>{ seed(); };
el.big.addEventListener('change',()=>{ gid('s_dot').style.background=el.big.checked?'#6ee7b7':'#4a5568'; });
}

/* ===================== RUNNER (CITY OF LIGHT) ===================== */
let runnerBooted=false;
function bootRunner(){ if(runnerBooted) return; runnerBooted=true;
const cvs=gid('r_canvas'); const {ctx}=setupCanvas(cvs);
const el={score:gid('r_score'), coins:gid('r_coins'), spd:gid('r_spd'), fps:gid('r_fps'), shield:gid('r_shield'), audio:gid('r_audio'), duck:gid('r_duck'), pause:gid('r_pause'), reset:gid('r_reset')};
let AC=null, master=null, audioOn=false;
function ensureAudio(){ if(AC) return; try{ AC=new (AudioContext||webkitAudioContext)(); master=AC.createGain(); master.gain.value=.18; master.connect(AC.destination); audioOn=true; el.audio.textContent='Audio: On'; }catch{} }
function toggleAudio(){ if(!AC){ ensureAudio(); return; } audioOn=!audioOn; el.audio.textContent = audioOn ? 'Audio: On' : 'Audio: Off'; }
function blip(f,d=.06,v=.28,type='sine'){ if(!AC||!audioOn) return; const t=AC.currentTime,o=AC.createOscillator(),g=AC.createGain(); o.type=type;o.frequency.setValueAtTime(f,t); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(v,t+.01); g.gain.exponentialRampToValueAtTime(0.0001,t+d); o.connect(g); g.connect(master); o.start(t); o.stop(t+d+.05); }

const W=()=>cvs.width/(window.devicePixelRatio||1), H=()=>cvs.height/(window.devicePixelRatio||1);
let paused=false, gameOver=false, last=performance.now(), frames=0, acc=0;

const ply={x:120,y:0,w:44,h:56,vy:0,ground:0,inv:0,duck:0,trail:[]};
const GRAV=1.05, GRAV_HOLD=0.42, JUMP_MIN=-20, JUMP_MAX=-30, HOLD_MAX_MS=260, COYOTE=10, BUF=10;
let coyote=0, buffer=0, holding=false, holdStart=0;

let score=0, coins=0, baseSpeed=6.0, shield=100;
const obs=[], tokens=[], fx=[]; let spawnCD=0, tokenCD=50;

/* Reset */
function reset(){ paused=false; gameOver=false; score=0; coins=0; frames=0; acc=0; shield=100; obs.length=0; tokens.length=0; fx.length=0; ply.trail.length=0;
  const feet=(H()-96)|0; ply.ground=feet; ply.h=56; ply.y=feet-ply.h; ply.vy=0; ply.inv=0; ply.duck=0; coyote=0; buffer=0; holding=false; holdStart=0;
  el.score.textContent='0'; el.coins.textContent='0'; el.shield.textContent='100%'; el.spd.textContent='1.0x';
}
reset();

/* Input */
function requestJump(v){ buffer=BUF; const onGround=(ply.y>=ply.ground-ply.h-0.1); if(onGround||coyote>0){ ply.vy=v; coyote=0; buffer=0; holding=true; holdStart=performance.now(); blip(640,.05,.22,'triangle');
  for(let i=0;i<22;i++) fx.push({x:ply.x+ply.w/2,y:ply.y+ply.h,vx:(Math.random()-0.5)*4,vy:-Math.random()*3-1,life:42,col:'#62d3ff'}); } }
function doDuck(){ if(ply.duck>0) return; const feet=ply.y+ply.h; ply.h=32; ply.y=feet-ply.h; ply.duck=18; blip(480,.04,.18,'square'); }
el.duck.onclick=doDuck;

/* Spawners */
function spawnObstacle(){ const g=ply.ground,r=Math.random();
  // beveled prisms
  if(r<0.35) obs.push({x:W()+40,y:g-28,w:28,h:28,t:'short'});
  else if(r<0.65) obs.push({x:W()+40,y:g-60,w:28,h:60,t:'tall'});
  else if(r<0.82) obs.push({x:W()+40,y:g-18,w:56,h:14,t:'low'});
  else { const d=60; obs.push({x:W()+40,y:g-30,w:26,h:30,t:'pair'}); obs.push({x:W()+40+d,y:g-30,w:26,h:30,t:'pair'}); }
}
function spawnToken(){
  // Stars (points) and Scrolls (bonus shield)
  const type = (Math.random()<0.75) ? 'star' : 'scroll';
  tokens.push({type, x:W()+24, y: ply.ground - 80 - Math.random()*80, r: (type==='star'?10:9), rot:0});
}

/* Background: City of Light */
function city(){
  const w=W(), h=H();
  // starfield
  ctx.fillStyle='#050912'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='rgba(236,243,255,.25)';
  for(let i=0;i<60;i++){ const x=( (i*73 + performance.now()*0.02) % (w+200) )-100; const y=(i*97)%h*0.017*h; ctx.fillRect((x|0), (y|0), 1, 1); }

  // skyline layers
  const t = performance.now()*0.00022;
  const layers = [
    {alpha:.14, scale:.35, speed:140, col1:'rgba(98,211,255,.9)', col2:'rgba(255,73,240,.9)'},
    {alpha:.18, scale:.55, speed:200, col1:'rgba(98,211,255,.9)', col2:'rgba(255,73,240,.9)'},
    {alpha:.22, scale:.85, speed:260, col1:'rgba(98,211,255,.9)', col2:'rgba(255,73,240,.9)'},
  ];
  for(const L of layers){
    ctx.save(); ctx.globalAlpha=L.alpha;
    ctx.translate(-(t*L.speed % w), 0);
    for(let i=0;i<16;i++){
      const bw=44+((i*71)%140), bh=120+((i*53)%160), x=(i*140)%w;
      neonRect(ctx, x, h-120*L.scale - bh*L.scale, bw*L.scale, bh*L.scale, L.col1, L.col2, .9);
      // billboard text
      if(i%5===0 && L.scale>.5){
        const bx=x+6, by=h-120*L.scale - bh*L.scale + 6;
        ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='bold 10px -apple-system,system-ui';
        const msg = ['GODTECH','JESUS','LIGHT','HOLY','GLORY'][i%5];
        ctx.fillText(msg, bx, by+10);
      }
    }
    ctx.restore();
  }

  // horizon glow + light beams
  const y=ply.ground;
  const hg=ctx.createLinearGradient(0,y-40,0,y+100); hg.addColorStop(0,'rgba(98,211,255,.12)'); hg.addColorStop(1,'rgba(98,211,255,0)');
  ctx.fillStyle=hg; ctx.fillRect(0,y-40,w,140);

  ctx.save(); ctx.globalAlpha=.08; ctx.fillStyle='#62d3ff';
  for(let i=0;i<6;i++){ const x=((i*200 + performance.now()*0.12) % (w+300))-150; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x+40,y); ctx.lineTo(x-40,y); ctx.closePath(); ctx.fill(); }
  ctx.restore();

  // ground line (crisp)
  ctx.fillStyle='rgba(255,255,255,.1)'; ctx.fillRect(0, lineSnap(y+2), w, 2);
}

/* Step + Draw */
function step(dt){
  if(paused||gameOver) return;
  const mult=1+Math.min(1.6,score/220), spd=baseSpeed*mult; el.spd.textContent=(spd/6).toFixed(1)+'x';

  // physics w/ variable gravity (hold for hang)
  const onGround=(ply.y>=ply.ground-ply.h-0.1);
  if(onGround) coyote=COYOTE; else coyote=Math.max(0,coyote-1);
  if(buffer>0 && (onGround||coyote>0)) requestJump(JUMP_MAX+1); else buffer=Math.max(0,buffer-1);
  const holdMs=holding ? performance.now()-holdStart : 0;
  const grav=(holding && holdMs<HOLD_MAX_MS && ply.vy<0)?GRAV_HOLD:GRAV;
  ply.vy+=grav; ply.y+=ply.vy; if(ply.y>ply.ground-ply.h){ ply.y=ply.ground-ply.h; ply.vy=0; holding=false; }
  if(ply.duck>0){ ply.duck--; if(ply.duck===0){ const feet=ply.y+ply.h; ply.h=56; ply.y=feet-ply.h; } }

  // spawn
  if(--spawnCD<=0){ spawnCD=Math.max(26, 92 - (score*0.7|0)); spawnObstacle(); }
  if(--tokenCD<=0){ tokenCD = 40 + (Math.random()*70|0); spawnToken(); }

  // obstacles
  let hit=false; const hb=()=>({x:ply.x+3,y:ply.y+(ply.duck?8:4),w:ply.w-6,h:(ply.duck?32:ply.h-8)});
  for(let i=obs.length-1;i>=0;i--){
    const o=obs[i]; o.x -= spd;
    const b=hb();
    if(o.x<b.x+b.w && o.x+o.w>b.x && o.y<b.y+b.h && o.y+o.h>b.y){ if(ply.inv<=0) hit=true; }
    if(o.x+o.w<-40){ obs.splice(i,1); score++; el.score.textContent=''+score; }
  }
  if(hit){
    shield=Math.max(0,shield-34); el.shield.textContent=shield+'%';
    flash(); blip(220,.12,.25,'square');
    for(let i=0;i<30;i++) fx.push({x:ply.x+ply.w/2,y:ply.y+ply.h/2,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.8)*5,life:36,col:'#ff49f0'});
    ply.inv=24; if(shield<=0) gameOver=true;
  }
  ply.inv=Math.max(0,ply.inv-1);

  // tokens
  for(let i=tokens.length-1;i>=0;i--){
    const c=tokens[i]; c.x -= spd; c.rot += 0.12;
    const cx=c.x, cy=c.y, r=c.r;
    if(cx+r>ply.x && cx-r<ply.x+ply.w && cy+r>ply.y && cy-r<ply.y+(ply.duck?32:ply.h)){
      tokens.splice(i,1);
      if(c.type==='star'){ coins++; el.coins.textContent=''+coins; blip(880,.05,.22,'sine'); }
      else { shield=Math.min(100, shield+16); el.shield.textContent=shield+'%'; blip(520,.06,.22,'sine'); }
      for(let k=0;k<16;k++) fx.push({x:cx,y:cy,vx:(Math.random()-0.5)*3,vy:(Math.random()-1.2)*3,life:28,col:'#ffd76a'});
    } else if (c.x+r<-20){ tokens.splice(i,1); }
  }

  // particles
  for(let i=fx.length-1;i>=0;i--){ const p=fx[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.15; p.life--; if(p.life<=0) fx.splice(i,1); }

  // trail
  const center={x:ply.x+ply.w*0.5, y:ply.y+(ply.duck?16:ply.h*0.5)}; ply.trail.push(center); if(ply.trail.length>26) ply.trail.shift();
}

function draw(){
  const w=W(), h=H(); city();

  // obstacles (beveled prisms)
  for(const o of obs){
    neonRect(ctx, o.x|0, o.y|0, o.w|0, o.h|0);
    ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.beginPath(); ctx.moveTo(lineSnap(o.x+2), lineSnap(o.y+2)); ctx.lineTo(lineSnap(o.x+o.w-2), lineSnap(o.y+2)); ctx.stroke();
  }

  // tokens
  for(const c of tokens){
    if(c.type==='star'){ star(ctx, c.x|0, c.y|0, c.r|0, c.rot); }
    else {
      // scroll: glowing rectangle with tiny cross
      neonRect(ctx, (c.x-8)|0, (c.y-10)|0, 16, 20, 'rgba(255,255,255,.85)', 'rgba(98,211,255,.9)', .85);
      ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fillRect(lineSnap(c.x), lineSnap(c.y-8), 1, 16);
      ctx.fillRect((c.x-6)|0, (c.y-1)|0, 12, 2);
    }
    // pickup ring
    ctx.save(); ctx.globalAlpha=.15; ctx.beginPath(); ctx.arc(c.x, c.y, c.r+6, 0, Math.PI*2); ctx.fillStyle='rgba(255,215,106,.4)'; ctx.fill(); ctx.restore();
  }

  // player: angelic runner — capsule + halo + wings + trail
  trail(ctx, ply.trail, 'rgba(98,211,255,.35)');
  const ph=ply.duck?32:ply.h;
  neonRect(ctx, ply.x|0, ply.y|0, ply.w|0, ph|0);
  halo(ctx, (ply.x+ply.w*0.5)|0, (ply.y-6)|0, 10);
  wing(ctx, (ply.x-4)|0, (ply.y+12)|0, -1);
  wing(ctx, (ply.x+ply.w+4)|0, (ply.y+12)|0, 1);
  if(ply.inv>0){ ctx.strokeStyle='rgba(255,255,255,.7)'; ctx.strokeRect(lineSnap(ply.x-1),lineSnap(ply.y-1),(ply.w+2)|0,(ph+2)|0); }

  // particles
  for(const p of fx){ ctx.fillStyle=p.col; ctx.fillRect(p.x|0,p.y|0,2,2); }

  if(gameOver){
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#ecf3ff'; ctx.font='18px -apple-system,system-ui,Segoe UI';
    ctx.fillText('Game Over — Tap to Restart',12,24);
  }
}

function loop(ts){ const dt=ts-last; last=ts; step(dt); draw(); frames++; acc+=dt; if(acc>500){ el.fps.textContent=String(Math.round(1000/(acc/frames))); frames=0; acc=0; } requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* Input */
function startJump(e){ if(gameOver){ reset(); return; } if(!AC&&e.isTrusted) ensureAudio(); const r=cvs.getBoundingClientRect(), rel=Math.max(0,Math.min(1,1-((e.clientY-r.top)/r.height))); const v=JUMP_MIN+(JUMP_MAX-JUMP_MIN)*rel; requestJump(v); e.preventDefault(); }
function endHold(){ holding=false; }
let swipeY=null;
cvs.addEventListener('pointerdown',e=>{ startJump(e); swipeY=e.clientY; },{passive:false});
cvs.addEventListener('pointermove',e=>{ if(swipeY!=null && e.clientY-swipeY>60){ doDuck(); swipeY=null; }},{passive:true});
cvs.addEventListener('pointerup',()=>{ endHold(); swipeY=null; },{passive:true});
cvs.addEventListener('pointercancel',()=>{ endHold(); swipeY=null; },{passive:true});
addEventListener('keydown',e=>{ if(e.code==='Space'){ e.preventDefault(); requestJump(JUMP_MAX); } if(e.code==='ArrowDown'){ e.preventDefault(); doDuck(); } });
el.pause.onclick=()=>{ if(gameOver){ reset(); return; } paused=!paused; el.pause.textContent=paused?'Resume':'Pause'; blip(paused?440:520,.06,.2); };
el.reset.onclick=()=>{ reset(); blip(720,.08,.25,'sine'); };
el.audio.onclick=()=>{ toggleAudio(); if(AC&&AC.state==='suspended') AC.resume(); };
} // bootRunner

/* Boot hub view */
show('hub');
</script>
</body>
</html>
